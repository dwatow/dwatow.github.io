---
title: "pimpl完全的資訊隱藏"
date: 2015-03-02T23:36:00.000+08:00
tags: 
- "C_and_Cpp"
categories:
- 舊部落格移植文章
---

# pimpl完全的資訊隱藏

原文連結: https://darkblack01.blogspot.com/2015/03/pimpl.html
移植時的最後更新日期: 2015-12-23T14:16:57.729+08:00

pimpl(pointer to implementation), 指向實作的指標。  這是《API Design for C++》Ch3.1的心得整理。<br />在此是要介紹，在C++中，如何實現「資訊隱藏狂熱」，class裡完全的將public以外的東西隱藏掉，在API設計中，這是很重要的，避免錯誤的使用，也讓設計更簡單好記。<br /><br />在此，作者也有提到Effective C++ #34也有提及這個技巧。<br />無獨有偶的，Code Complete 2/e中也有提到。不過在《API Design for C++》中有強調，這是C++獨有的技巧，所以不算是通用的Design Pattern，不過，算是很厲害的Design Pattern for C++。<br /><br />(在此，不使用書中的範例程式)<br />這個例子，是<a href="http://darkblack01.blogspot.tw/2012/09/cpp.html">隱藏.cpp裡一切細節的範例程式</a>的延伸版。<br />類別要描述的是「不會透露自己的年紀的人」。<br />透過pimpl技巧，強調「不會透露自己的年紀的人，更不會跟別人透露不想提及的意圖」。<br /><pre class="prettyprint"><code>//Person.h<br />#include &lt;string&gt;<br />#include "date.h"<br />#include "address.h"<br /><br />class Person<br />{<br />    std::string theName;<br />    Date theBirthDate;<br />    Address theAddress;<br />    int GetYears(int currYear);<br />public:<br />    Person();<br />    ~Person();<br />    Person(const std::string&amp; name,<br />           const Date&amp; birthday,<br /><br />    std::string name() const;<br />    std::string birthDate() const;<br />    std::string address() const;<br />    //...<br />};</code></pre><h2><span style="font-size: x-large;">極致的資訊隱藏手法</span></h2>我們希望它可以只露出必要的部份，所以將它改寫成這樣 <br /><pre class="prettyprint"><code>//Person.h<br />#include &lt;string&gt;<br />#include "date.h"<br />#include "address.h"<br /><br />class Person<br />{<br />    class PersonImpl;   //如果使用上造成太多存取的限制，可以考慮將這一行改成public<br />    PersonImpl* pImpl;  //宣告一個實作類別的指標（或參考也行，就是不可以是實體）<br />public:<br />    Person();<br />    ~Person();<br />    Person(const std::string&amp; name, <br />           const Date&amp; birthday,<br />           const Address&amp; addr);<br /><br />    std::string name() const;<br />    std::string birthDate() const;<br />    std::string address() const;<br />    //...<br />};</code></pre><pre class="prettyprint"><code>//Person.cpp<br />#include "Person.h"<br /><br />class Person::PersonImpl<br />{<br />public:<br />    std::string theName;<br />    Date theBirthDate;    <br />    Address theAddress;<br /><br />    int GetYears(int currYear)<br />    {<br />        return currYear - BirthDate.Year();<br />    }<br />};<br /><br />Person::Person(const std::string&amp; name, <br />               const Date&amp; birthday,<br />               const Address&amp; addr):<br />pImpl(new PersonImpl())<br />{<br />    pImpl-&gt;theName = name;<br />    pImpl-&gt;theBirthDate = birthday;<br />    pImpl-&gt;theAddress = addr;<br />};<br /><br />Person::~Person()<br />{<br />    delete pImpl;<br />    pImpl = 0;<br />}<br /></code></pre>除此之外，對於類別的複製建構式與賦值運算子的override都是必須要注意的實作細節唷。<br /><br /><h2><span style="font-size: x-large;">使用Smart Pointer</span></h2>書裡還建議使用smart pointer避免使用這種方式時，pimpl實作不見了的情況。<br /><pre class="prettyprint"><code>//Person.h<br />#include &lt;personimpl&gt;<br />#include "date.h"<br />#include "address.h"<br /><br />class Person<br />{<br />    class PersonImpl;   //如果使用上造成太多存取的限制，可以考慮將這一行改成public<br />    std::unique_ptr<personimpl> pImpl;  //使用適合的Smart Pointer<br />public:<br />    Person();<br />    ~Person();<br />    explicit Person(const std::string&amp; name, <br />           const Date&amp; birthday,<br />           const Address&amp; addr);<br /><br />    std::string name() const;<br />    std::string birthDate() const;<br />    std::string address() const;<br />    //...<br />};</personimpl></code></pre><ul><li>shared_ptr 指向相同的物件，誤刪不消失。&nbsp;</li><li>scoped_ptr 保證唯一，無法複製。</li></ul><br /><h2><span style="font-size: x-large;">pImpl的優點</span></h2><ul><li>Information Hidding</li><li>降低耦合</li><li>加快編譯</li><li>...</li></ul><br /><h2><span style="font-size: x-large;">pImpl的缺點</span></h2><ul><li>增加一點點的物件大小</li><li>降低程式碼可讀性</li><li>提高維護程本(除錯時要追程式碼就困難許多了)</li><li>類別中的const函數，無法保證private的成員變數唯讀(只保證pImpl的指標不改變)</li></ul><br />而這篇就是紀錄書中，如何改寫的注意事項。<br />詳細的細節，還是去看書吧！^^這本書很棒唷！<br /><br /><h4><span style="font-size: large;">參考資料:&nbsp;</span></h4>[1] <a href="http://epaper.gotop.com.tw/PDFSample/AXP015100.pdf">3.1 Pimpl慣用語 - C++ API 設計</a>&nbsp; <br /><div>[2] <a href="http://blog.csdn.net/juxua_xatu/article/details/19981081">Pimpl淺出</a><br />[3] <a href="http://ptgmedia.pearsoncmg.com/images/9780321334879/samplepages/0321334876.pdf" target="_blank">Effective C++ 3/e Item 9, 10, 27, 47</a></div>
