---
title: "Git之...雙bare同步"
date: 2015-03-20T10:27:00.001+08:00
tags: 
- "Git"
categories:
- 舊部落格移植文章
---

# Git之...雙bare同步

原文連結: https://darkblack01.blogspot.com/2015/03/gitbare.html
移植時的最後更新日期: 2015-03-20T10:48:25.570+08:00

有時候因為操作習慣或備份，會架設兩個git bare，並且希望彼此同步。<br /><br />雖然git本身並不是用一個git sync做到和所有的repo同步。<br />但是git有一個叫hook的客製化事件觸發(Pro Git中文版翻譯成掛鉤)<br /><br />可以在指定的時機，執行指定的動作。<br />這麼一來可以擴充git很多功能，我想也是因為這樣，git才能和很多open source的工具整合得很好的原因。<br /><br />現在就來看看，如何做到同步bare<br /><br /><h2><span style="font-size: x-large;">建立Bare</span></h2>首先，我們要兩個bare<br /><br />Main &nbsp;用git init --bare 建立<br />Mirror &nbsp;用git clone --mirror --bare &lt;Main Path&gt;建立<br /><br />讓Mirror成為Main的鏡像，這麼做的原因有兩個，也是我們要放hook的內容<br />在Mirror執行git push，即可讓Main有Mirror。<br />在Mirror執行git fetch，即可讓Mirror有Main。<br />(不過，彼此會互蓋，要小心)<br /><br /><h2><span style="font-size: x-large;">安裝Hook</span></h2>Git的Server hook有兩個事件可以使用，pre-receive和post-receive<br />在此，<span style="color: red;">必須安裝在Mirror</span>，client執行 git push時，會先執行<br /><ol><li>pre-receive</li><li>將你push的內容放到bare裡</li><li>執行post-receive</li></ol><br />如果在1.的時候，先git fetch，和Main同步，在3. 的時候git push讓Main和Mirror一樣。<br />那麼兩邊就可以同步了！<br /><br /><h2><span style="font-size: x-large;">建立clone</span></h2>Client建議clone Mirror這一邊，操作比較順暢。<br />如果萬一有人cline了Main，然後提交了，是不是會造成衝突呢？<br />這是一定的！就像是兩個人對同一個bare做push一樣。<br /><br /><h2><span style="font-size: x-large;">同步衝突</span></h2>這時，同步機制會卡在pre-receive做完fetch時，無法將你要push上來的東西放好，造成衝突，所以push失敗，這時你要執行git pull將同步好的下載下來，解決衝突，再重新push，即可解決。<br /><br /><h2><span style="font-size: x-large;">Hook內容</span></h2>最後的問題是hook的shell腳本怎麼寫？<br />sample的內容好複雜呀！？<br />我就在此獻醜一下，看看是不是有更好的做法(一定的有的啦)<br /><h3><span style="font-size: large;">post-receive </span></h3><pre class="prettyprint"><code class="language-sh">#!/bin/sh<br />git push<br /><br />exit 0</code></pre><h3><span style="font-size: large;">pre-receive </span></h3><pre class="prettyprint"><code class="language-sh">#!/bin/sh<br />git fetch</code></pre><br /><h2><span style="font-size: x-large;">參考資料&nbsp;</span></h2><a href="http://git-scm.com/book/zh-tw/v1/Git-%E5%AE%A2%E8%A3%BD%E5%8C%96-Git-Hooks" target="_blank">[1] 7.3 Git 客製化 - Git Hooks</a>
