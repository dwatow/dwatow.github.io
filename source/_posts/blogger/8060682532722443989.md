---
title: "重新包裝CFileDialog"
date: 2014-03-03T17:02:00.000+08:00
tags: 

categories:
- 舊部落格移植文章
---

# 重新包裝CFileDialog

原文連結: https://darkblack01.blogspot.com/2014/03/cfiledialog.html
移植時的最後更新日期: 2014-03-03T17:03:50.490+08:00

通常，我們呼叫FileDialog，要嘛就是選取多檔，要嘛就是選取一檔。這個限制設計，是需要的，不然可能會造成選檔結果的錯誤。<br /><br />為了簡化整個過程，在此重新包裝了整個類別的細部。<br />來看程式碼吧！<br /><br />選取單一檔案的CFileDialogSingle<br /><br /><pre class="prettyprint"><code>#ifndef CFILEDLGSINGLE_H<br />#define CFILEDLGSINGLE_H<br /><br />enum FDlgType{SAVEAS = 0, OPEN = 1};<br />#include &lt;vector&gt;<br /><br />class CFileDlgSingle<br />{<br />    CFileDialog* m_pFileDlg;<br />    FDlgType m_isOpen;<br />    std::vector&lt;CString&gt; m_filters;<br />    CString getFilters();<br /><br />public:<br />    CFileDlgSingle(FDlgType isOpen);<br />    ~CFileDlgSingle();<br />    //CFileDlgSingle()<br /><br />    void AddFileFilter(CString descript, CString exName);<br /><br />    int DoModal();<br />    int Show(){ return DoModal(); }<br /><br />    CString GetFileExt() const<br />    { return m_pFileDlg-&gt;GetFileExt(); }<br /><br />    CString GetFileName() const<br />    { return m_pFileDlg-&gt;GetFileName(); }<br /><br />    CString GetFileTitle() const<br />    { return m_pFileDlg-&gt;GetFileTitle(); }<br /><br />    CString GetFolderPath() const<br />    { return m_pFileDlg-&gt;GetFolderPath(); }<br /><br />    CString GetPathName() const<br />    { return m_pFileDlg-&gt;GetPathName(); }<br />};<br /><br /><br />#endif<br /></code></pre><pre class="prettyprint"><code>#include "stdafx.h"<br />#include "FileDlgSingle.h"<br />#include &lt;iterator&gt;<br /><br />CFileDlgSingle::CFileDlgSingle(FDlgType isOpen) :m_isOpen(isOpen){ }<br />CFileDlgSingle::~CFileDlgSingle(){ delete m_pFileDlg; }<br /><br />CString CFileDlgSingle::getFilters()<br />{<br />    CString totalFilters;<br />    for (std::vector&lt;CString&gt;::iterator it = m_filters.begin(); it != m_filters.end(); ++it)<br />    {<br />        totalFilters += *it + "|";<br />    }<br />    return totalFilters + "|";<br />}<br /><br />void CFileDlgSingle::AddFileFilter(CString descript, CString exName)<br />{<br />    CString oneFilter;<br />    oneFilter = descript + "(*." + exName + ")|*." + exName;<br />    m_filters.push_back(oneFilter);<br />}<br /><br />int CFileDlgSingle::DoModal()<br />{<br />    m_pFileDlg = new CFileDialog(m_isOpen, NULL, NULL, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, getFilters(), NULL);<br />    return m_pFileDlg-&gt;DoModal();<br />}</code></pre>選取多個檔案的CFileDialogMulti<br /><pre class="prettyprint"><code>#ifndef CFILEDLGSINGLE_H<br />#define CFILEDLGSINGLE_H<br /><br />enum FDlgType{SAVEAS = 0, OPEN = 1};<br />#include &lt;vector&gt;<br /><br />class CFileDlgMulti<br />{<br />    CFileDialog* m_pFileDlg;<br />    FDlgType m_isOpen;<br />    std::vector&lt;CString&gt; m_filters;<br />    CString getFilters();<br /><br />    CString m_szFileNameBuffer;<br />public:<br />    CFileDlgMulti(FDlgType isOpen);<br />    ~CFileDlgMulti();<br />    //CFileDlgSingle()<br /><br />    void AddFileFilter(CString descript, CString exName);<br /><br />    int DoModal();<br />    int Show(){ return DoModal(); }<br /><br />    CString GetFileExt() const<br />    { return m_pFileDlg-&gt;GetFileExt(); }<br /><br />    CString GetFileName() const<br />    { return m_pFileDlg-&gt;GetFileName(); }<br /><br />    CString GetFileTitle() const<br />    { return m_pFileDlg-&gt;GetFileTitle(); }<br /><br />    CString GetFolderPath() const<br />    { return m_pFileDlg-&gt;GetFolderPath(); }<br /><br />    CString GetPathName() const<br />    { return m_pFileDlg-&gt;GetPathName(); }<br /><br />    const int GetSelFileList(std::vector&lt;CString&gt;&amp; vstrFilePath);<br />    void SetSelMultiFileTotal(const int&amp; FileMaxBuffer);<br />};<br /><br />#endif<br /></code></pre><pre class="prettyprint"><code>#include "stdafx.h"<br />#include "FileDlgMulti.h"<br />#include &lt;iterator&gt;<br /><br />CFileDlgMulti::CFileDlgMulti(FDlgType isOpen) :m_isOpen(isOpen){ }<br />CFileDlgMulti::~CFileDlgMulti(){ delete m_pFileDlg; }<br /><br />CString CFileDlgMulti::getFilters()<br />{<br />    CString totalFilters;<br />    for (std::vector&lt;CString&gt;::iterator it = m_filters.begin(); it != m_filters.end(); ++it)<br />    {<br />        totalFilters += *it + "|";<br />    }<br />    return totalFilters + "|";<br />}<br /><br />void CFileDlgMulti::AddFileFilter(CString descript, CString exName)<br />{<br />    CString oneFilter;<br />    oneFilter = descript + "(*." + exName + ")|*." + exName;<br />    m_filters.push_back(oneFilter);<br />}<br /><br />int CFileDlgMulti::DoModal()<br />{<br />    m_pFileDlg = new CFileDialog(m_isOpen, NULL, NULL, OFN_ALLOWMULTISELECT | OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, getFilters(), NULL);<br />    return m_pFileDlg-&gt;DoModal();<br />}<br /><br />const int CFileDlgMulti::GetSelFileList(std::vector&gt;CString&gt;&amp; vstrFilePath)<br />{<br />    // 取得第一個檔案名稱的位置 若沒有的話傳回NULL<br />    POSITION pos = m_pFileDlg-&gt;GetStartPosition();<br />    if (pos) vstrFilePath.clear();<br />    while(pos != NULL)<br />        vstrFilePath.push_back(m_pFileDlg-&gt;GetNextPathName(pos));// 透過位置來取得檔案名稱 檔案名稱包含完整路徑<br />    return (int)vstrFilePath.size();<br />}<br /><br />void CFileDlgMulti::SetSelMultiFileTotal(const int&amp; FileMaxBuffer)<br />{<br />    const int BufferSize = (FileMaxBuffer * (MAX_PATH + 1)) + 1;<br />    m_pFileDlg-&gt;m_ofn.nMaxFile = BufferSize;<br />    m_pFileDlg-&gt;m_ofn.lpstrFile = m_szFileNameBuffer.GetBuffer(BufferSize);<br />    m_szFileNameBuffer.ReleaseBuffer();<br />    m_pFileDlg-&gt;m_ofn.lpstrFile[0] = NULL;<br />}</code></pre>這兩組程式碼其實可以提取共同的部份做為抽象類別。<br />有空再來試試吧！^^<br />最重要的就是，使用端的程式碼會有多簡單。 <pre class="prettyprint"><code>CFileDlgSingle dlgFile(OPEN);<br />dlgFile.AddFileFilter("純文字檔", "txt");<br />dlgFile.AddFileFilter("All File", "*");<br />dlgFile.Show();<br /><br />m_staticText.SetWindowText(dlgFile.GetPathName());</code></pre>
