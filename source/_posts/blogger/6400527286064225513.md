---
title: CFileDialog的m_ofn緩充區設定
date: 2012-08-13T13:20:00.000+08:00
tags: 
- WIN32 API/MFC

categories:
- 舊部落格移植文章
---

# CFileDialog的m_ofn緩充區設定

原文連結: https://darkblack01.blogspot.com/2012/08/cfiledialogmofn.html
移植時的最後更新日期: 2012-08-13T13:30:17.773+08:00

<br />MFC的Class，不好用是用過都不喜歡的！就是有很多小地方要注意。<br />MFC的Class，好用是用過都難以忘記的！就是有很多架構都弄得好好的。<br />可以說是半成品，所以我就想把所有用過的Class的注意小細節，再包一層Class起來！（算是一個大計劃吧！也許有人做過了！）<br /><br />這一次是CFileDialog（之前對它的<a href="http://darkblack01.blogspot.tw/2012/05/cfiledialog.html" target="_blank">了解</a>，就只是認識這個函數，其它都沒有記錄下來）<br /><br />&nbsp; &nbsp; <span style="color: #3d85c6;">CFileDlg aFileDialog (TRUE, NULL, NULL, OFN_ALLOWMULTISELECT, m_strFilter); </span><br /><br />在這樣使用時，總是會有緩充區的問題。<br />這一次設定了好久，終於弄好了！想說這個code以後要保留下來，所以要把它再包一層下來。<br /><br /><a name='more'></a><br /><br /><span style="font-size: large;"><b>Sample Code</b></span><br />void CSelExcelDlg::OnButtonFindfile()<br />{<br />&nbsp; &nbsp; <span style="color: #999999;">// TODO: Add your control notification handler code here</span><br />&nbsp; &nbsp; CString m_strFilter("OrigMsrData Files (*.omd)|*.omd|Text File(*.txt)|*.txt|All Files (*.*)|*.* ||");<span style="color: #999999;">//檔案過濾條件</span><br />&nbsp; &nbsp; CFileDlg aFileDialog (TRUE, NULL, NULL, <span style="color: #cc0000;">OFN_ALLOWMULTISELECT</span>, m_strFilter);<br /><br />&nbsp; &nbsp; aFileDialog.<span style="color: #cc0000;">SetMultiFileNameBuffer</span>(100);<br /><br />&nbsp; &nbsp; int nID = aFileDialog.DoModal();<br />&nbsp; &nbsp; if (nID == IDOK)<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; HDFileCouont = aFileDialog.GetSelFileList(m_lstSelFileList); &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; if(CommDlgExtendedError() == FNERR_BUFFERTOOSMALL) &nbsp;<span style="color: #3d85c6;">//FNERR_BUFFERTOOSMALL要#include "cderr.h"</span><br />&nbsp; &nbsp; &nbsp; &nbsp; AfxMessageBox( "Sel Excel Dialog緩衝區不夠大\n剪下畫面，並且找程式設計師解決這問題。");<br /><br />}<br /><br /><b><span style="font-size: large;">CFileDlg&nbsp;.h</span></b><br />class CFileDlg : public CFileDialog<br />{<br /><span style="color: #3d85c6;">//在Class裡設定一個CString當作Buffer是避免兩種情況</span><br /><span style="color: #3d85c6;">//若宣告在CFileDlg.SetMutiFileNameBuffer()裡，則設定完Buffer之後，這個字串空間就消失了。會造成緩充區不足或沒有緩充區的問題。</span><br /><span style="color: #3d85c6;">//若宣告在在Sample Code裡則就沒有OO的架構，否則，原本找到的Code（MSDN的Code）是放在 Sample Code&nbsp;的。</span><br />&nbsp; &nbsp; CString szFileNameBuffer;<br /><br />public:<br />&nbsp; &nbsp; void <span style="color: #cc0000;">SetMultiFileNameBuffer</span>(const int);<br />};<br /><br /><b><span style="font-size: large;">CFileDlg.cpp</span></b><br />void CFileDlg::<span style="color: #cc0000;">SetMultiFileNameBuffer</span>(const int FileMaxBuffer)<br />{<br />&nbsp; &nbsp; const int BufferSize = (FileMaxBuffer * (MAX_PATH + 1)) + 1;<br />&nbsp; &nbsp; m_ofn.nMaxFile = BufferSize;<br />&nbsp; &nbsp; m_ofn.lpstrFile = szFileNameBuffer.GetBuffer(BufferSize);<br />&nbsp; &nbsp; m_ofn.lpstrFile[0] = NULL;<br />}<br /><br />
