---
title: 抱怨VC6//File: afx.ini Line: 122 的bug
date: 2013-04-15T14:47:00.001+08:00
tags: 
- 抱怨VC6
,- WIN32 API/MFC

categories:
- 舊部落格移植文章
---

# 抱怨VC6//File: afx.ini Line: 122 的bug

原文連結: https://darkblack01.blogspot.com/2013/04/vc6file-afxini-line-122-bug.html
移植時的最後更新日期: 2013-04-15T14:47:56.261+08:00

這個MFC的問題，我在網路上也是找了很久，沒有解，一直到無意間解開了！再重現。以下是以我自己的case做範例重現。<br /><br /><br />我的main project使用SDI，利用Menu打開各種的Dialog做操作，各個Dialog我都做一個sub project檔來個別開發、測試，最後在main project用#include的方式把code加入，再把dialog的interface給拉到main project，這樣就可以使用。<br /><br />但是，這樣卻引發了一個隱藏的問題。<br /><br /><a name='more'></a><br /><br /><h3><span style="font-size: large;">問題描述：</span></h3>我想要把sub project給刪除掉，並且將code整合到main project。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-tyYpicQxZ70/UWuYb4n98VI/AAAAAAAAEsM/ydNpZz_K2q4/s1600/%E6%8F%8F%E8%BF%B01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="154" src="http://2.bp.blogspot.com/-tyYpicQxZ70/UWuYb4n98VI/AAAAAAAAEsM/ydNpZz_K2q4/s640/%E6%8F%8F%E8%BF%B01.png" width="640" /></a></div><br />這兩個project重疊的檔案<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-yklPqMFiiRE/UWuYbjDkz7I/AAAAAAAAEsI/eLp04b1nCfY/s1600/%E6%8F%8F%E8%BF%B02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="296" src="http://1.bp.blogspot.com/-yklPqMFiiRE/UWuYbjDkz7I/AAAAAAAAEsI/eLp04b1nCfY/s400/%E6%8F%8F%E8%BF%B02.png" width="400" /></a></div><br /><br />從這開始操作<br /><br />在main project中，加入code<br />新增dialog(命名了相同的名字)<br />複製sub project中要的dialog所有的member function<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-_624yNrx1Iw/UWuYctc9eDI/AAAAAAAAEss/5xSgzeDdujM/s1600/%25E6%258F%258F%25E8%25BF%25B03.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="420" src="http://3.bp.blogspot.com/-_624yNrx1Iw/UWuYctc9eDI/AAAAAAAAEss/5xSgzeDdujM/s640/%25E6%258F%258F%25E8%25BF%25B03.png" width="640" /></a></div><br />執行程式<br /><br /><div class="separator" style="clear: both; text-align: center;"></div>開啟這次移植的dialog，出現了這次問題的主角<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-frmGBQg0ovM/UWuYcU5Z-bI/AAAAAAAAEsc/qZosBKP75iE/s1600/%E6%8F%8F%E8%BF%B05.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="198" src="http://3.bp.blogspot.com/-frmGBQg0ovM/UWuYcU5Z-bI/AAAAAAAAEsc/qZosBKP75iE/s640/%E6%8F%8F%E8%BF%B05.png" width="640" /></a></div><br /><h3><span style="font-size: large;">收集線索</span></h3>先來看看什麼是<br />afx.ini line: 122<br /><br /><pre class="prettyprint"><code>// CString<br />_AFX_INLINE CStringData* CString::GetData() const<br />{ <br />    ASSERT(m_pchData != NULL); <br />    return ((CStringData*)m_pchData)-1;<br />}</code></pre>CString???<br /><br />再看看dialog啟動的程式段<br /><pre class="prettyprint"><code>void CColorEyeIApp::OnFileOmdtoxls() <br />{<br />    // TODO: Add your command handler code here<br />    CSelExcelDlg dlgSelExcel;<br />    dlgSelExcel.DoModal();<br />}</code></pre>用debugger看看程式執行<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-uOiMDwtgPO0/UWudnGygt7I/AAAAAAAAEs4/2gGw_lPcu2U/s1600/%E5%95%8F%E9%A1%8C1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="352" src="http://4.bp.blogspot.com/-uOiMDwtgPO0/UWudnGygt7I/AAAAAAAAEs4/2gGw_lPcu2U/s640/%E5%95%8F%E9%A1%8C1.png" width="640" /></a></div><br />到此收集到的線索及推測<br />「此bug是由button按下之後，到dialog::deconstruct()執行完畢出的問題。」<br />變成<br />「此bug是由程式deconstruct執行完畢出的問題。」<br /><br />先看看是~CString()還是~CSelExcelDlg()的問題？<br />~CSelExcelDlg()沒有override，那找找看~CString()出問題的可能性。<br /><br />看看CSelExcelDlg中，到底有沒有CString<br /><pre class="prettyprint"><code>class CSelExcelDlg : public CDialog<br />{<br />    FormType   m_ft;<br />    int        m_openOmdLimit;<br />     std::vector&gt;&lt;cstring&gt; m_omdFilesList;    //   m_vOmdFilePathList;<br />//…<br /></code></pre>發現CString！！！<br /><br />這個CString member variable相關的member function都註解掉<br /><br />執行程式 <br /><ol><li>按下Cancel&nbsp;</li><li>~CSelExcelDlg&nbsp;</li><li><strike>~CString&nbsp;</strike></li><li>當掉&nbsp;</li></ol><br />還是當掉了。<br /><br />問題就是沒有被overload的~SelExcelDlg了？！<br /><br />李組長眉頭一皺，發現案情並不單純！<br /><br />怎麼可能沒override卻出了問題？<br /><br /><h3><span style="font-size: large;">問題真正的解法</span></h3>就在整理程式碼(刪掉SelXls/SelExcelDialog.h &amp;&nbsp;SelXls/SelExcelDialog.cpp)之後，發現#include出了問題<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-GrIPw9KMwjk/UWuYcN9AC-I/AAAAAAAAEsg/qzEge8HMjEo/s1600/%25E6%258F%258F%25E8%25BF%25B04.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="150" src="http://2.bp.blogspot.com/-GrIPw9KMwjk/UWuYcN9AC-I/AAAAAAAAEsg/qzEge8HMjEo/s640/%25E6%258F%258F%25E8%25BF%25B04.png" width="640" /></a></div><br />修正#include的檔案之後。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-D777Ze4wYEQ/UWuhZjaau3I/AAAAAAAAEtI/JB7IDNp7F9Y/s1600/solution.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="224" src="http://2.bp.blogspot.com/-D777Ze4wYEQ/UWuhZjaau3I/AAAAAAAAEtI/JB7IDNp7F9Y/s640/solution.png" width="640" /></a></div><br /><span style="font-size: large;">再Rebuild All，就好了。</span>
