---
title: "可怕的繪圖資源異常Bug"
date: 2012-01-20T23:54:00.000+08:00
tags: 
- "WIN32 API/MFC"
categories:
- 舊部落格移植文章
---

# 可怕的繪圖資源異常Bug

原文連結: https://darkblack01.blogspot.com/2012/01/bug.html
移植時的最後更新日期: 2012-01-29T18:37:01.400+08:00

<br /><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">上次說繪圖出現問題的bug</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">抓到了！</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">真是發生奇蹟了！</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;"></span><br /><a name='more'></a></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">奇蹟指的是，我竟然看出來（或者想得到）問題在這個方向...</span><br /><span style="font-family: inherit;">而不是專注在某一段語法產生的問題。</span><br /><span style="font-family: inherit;"><br /></span><br /><span style="font-family: inherit;">因為TextOut是正常的，</span><span style="background-color: white; font-family: inherit;">所以仔細觀察發現CBrush和CPen重繪次數超過一定的數量（很大的數量）</span><span style="background-color: white; font-family: inherit;">就會崩潰，和它們被DeleteObject一樣</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">所以，就針對這兩個物件做檢查，</span><span style="background-color: white; font-family: inherit;">並且上網看看人家都怎麼做的...</span><br /><span style="background-color: white; font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">發現....</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">Pen 部份</span></div><div style="background-color: white; line-height: 16px;"><span style="color: #0b5394; font-family: inherit;">OldPen = dc.SelectObject(NewPen);</span></div><div style="background-color: white; line-height: 16px;"><span style="color: #0b5394; font-family: inherit;">（繪圖）</span></div><div style="background-color: white; line-height: 16px;"><span style="color: #0b5394; font-family: inherit;">dc.SelectObject(OldPen);</span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 16px;"><span style="font-family: inherit;">Brush的部份</span></div><div style="background-color: white; line-height: 16px;"><span style="color: #0b5394; font-family: inherit;"><span style="line-height: 23px; text-align: left;">m_brBack.DeleteObject();&nbsp;</span><br style="line-height: 23px; text-align: left;" /><span style="line-height: 23px; text-align: left;">m_brBack.CreateSolidBrush(RGB(255,255,0));&nbsp;</span></span></div><div style="background-color: white; line-height: 16px;"><span style="line-height: 23px; text-align: left;"><span style="font-family: inherit;"><br /></span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">做了</span></span><br /><span style="line-height: 23px;"><span style="font-family: inherit;">1. 儲存預設</span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">2. 新的筆或筆刷替代預設</span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">3. 繪圖</span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">4. 再將預設值替代新的筆或筆刷</span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">的動作</span></span><br /><span style="line-height: 23px;"><span style="font-family: inherit;"><br /></span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">程式的繪圖就不會因為次數太多，而失控。</span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;"><br /></span></span></div><div style="background-color: white; line-height: 16px; text-align: left;"><span style="line-height: 23px;"><span style="font-family: inherit;">因為我用 MFC寫了UI介面動畫，所以要快速且大量的更新畫面</span></span></div><div id="yui_3_2_0_1_1326933017188423" style="background-color: white; line-height: 16px; text-align: left;"><span id="yui_3_2_0_1_1326933017188420" style="line-height: 23px;"><span style="font-family: inherit;">才會出現這樣的問題。</span></span><br /><span style="background-color: white; font-family: inherit; line-height: 23px;">哈哈~~</span></div><div style="background-color: white; line-height: 13px;"><span style="background-color: white; font-family: inherit;"><br /></span><br /><span style="background-color: white; font-family: inherit;">我</span><span style="background-color: white; font-family: inherit;">原本的寫法是如下，</span><span style="background-color: white; font-family: inherit;">單純的只是將它設定而已。</span></div><div style="background-color: white; line-height: 13px;"><span style="font-family: inherit;"><br /></span></div><div id="yui_3_2_0_1_1326933017188277" style="background-color: white;"><div style="line-height: 16px;"><span style="font-family: inherit;">Pen 部份</span></div><div style="line-height: 16px;"><span style="color: #0b5394; font-family: inherit;">dc.SelectObject(NewPen);</span></div><div id="yui_3_2_0_1_1326933017188276" style="line-height: 16px;"><span style="color: #0b5394; font-family: inherit;">（繪圖）</span></div><div style="line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="line-height: 16px;"><span style="font-family: inherit;"><br /></span></div><div style="line-height: 16px;"><span style="font-family: inherit;">Brush的部份</span></div><div style="line-height: 13px;"><span style="line-height: 23px; text-align: left;"><span style="color: #0b5394; font-family: inherit;">m_brBack.CreateSolidBrush(RGB(255,255,0));&nbsp;</span></span></div><div><div style="font-family: times, serif; font-size: 16px; line-height: 13px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 13px;"><span style="line-height: 23px; text-align: left;"><br /></span></span></div><div style="font-family: times, serif; font-size: 16px; line-height: 13px;"><span style="font-family: arial, helvetica, sans-serif; font-size: 13px;"><span style="line-height: 23px; text-align: left;"><br /></span></span></div><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;"></span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">大神回覆：</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">You need to make sure the &nbsp;graphic resources such as Pen and Brush are released ( by calling DeleteObject )after you are done with them.</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">Otherwise, you might run out of resource quickly. &nbsp;This also explain why &nbsp;when WM_PAINT is not called, you don't see this problem.</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">Suggestion:</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">&nbsp;Add some code to keep track the graphic resource allocation/deallocation count to see if they are equal.</span><br /><span style="font-family: arial, helvetica, sans-serif; font-size: x-small; line-height: 23px; text-align: left;">If they are not, force your program to stop (by adding an assertation), that way you could easily spotting resource leakage.</span><br /></div><div><div style="text-align: left;"><span style="line-height: 23px;"><br /></span></div></div></div>
