---
title: "重構CH1//未重構原始碼"
date: 2012-11-24T16:43:00.002+08:00
tags: 
- "重構"
categories:
- 舊部落格移植文章
---

# 重構CH1//未重構原始碼

原文連結: https://darkblack01.blogspot.com/2012/11/blog-post_24.html
移植時的最後更新日期: 2012-11-24T20:25:06.094+08:00

重構是什麼？<br /><div>《重構》的第一章表演了一段「什麼是重構？」</div><div>在這，把程式碼弄成C++，同義的表演<strike>抄</strike>一次。</div><div><br /></div><div><b>程式規格：</b></div><div><br /><ul><li>影片出租店用的程式<br />計算每一位顧客的消費金額並列印報表（statment）</li><li><b>操作者告訴程式</b>&nbsp; &nbsp; 顧客租了哪些影片？<br />&nbsp; &nbsp; 租期多長？<br />程式便計算出費用</li><li><b>影片分為三類</b>普通片、兒童片、新片</li><li>除了計算費用，還要<b>為常客計算點數</b>依照「是否為新片」而所有不同</li></ul></div><div><br /><h2><span style="font-size: large;">原本的程式碼<a name='more'></a></span></h2>第一個類別<br /><pre class="prettyprint"><code>#include&lt;string&gt;<br /><br />class Movie<br />{<br />        std::string _title;   //名稱<br />        int _priceCode;       //價格（代號）<br />    public:<br />        static int CHILDERNS = 2;<br />        static int REGULAR = 0;<br />        static int NEW_RELEASE = 1;<br /><br />        Moive(String title, int priceCode);<br />        int  getPriceCode();<br />        void setPriceCode(int arg);<br />        String getTitle();<br />};<br /><br />inline Movie::Moive(String title, int priceCode)<br />{<br />    _title = title;<br />    _priceCode = priceCode;<br />}<br /><br />inline int Movie::getPriceCode()<br />{<br />    return  _priceCode;<br />}<br /><br />inline String Movie::getTitle()<br />{<br />    return _title;<br />}<br /><br />inline void Movie::setPriceCode()<br />{<br />    _priceCode = arg;<br />}</code></pre></div><br /><br />第二個類別<br /><pre class="prettyprint"><code>#include "CMovie.h"<br /><br />class Rental<br />{<br />    Movie _movie;     //影片<br />    int _dayRented;   //租期<br /><br />    public:<br />        Rental(Movie movie, int dayRented);<br />        int getDaysRented();<br />        Movie getMovie();<br />};<br /><br />inline Rental::Rental(Movie movie, int dayRented)<br />{<br />    _movie = movie;<br />    _dayRented = daysRented;<br />}<br /><br />inline int Rental::getDaysRented()<br />{<br />    return _dayRented;<br />}<br /><br />inline Movie Rental::getMovie()<br />{<br />    return _movie;<br />}<br /><br /></code></pre><br /><br />第三個類別<br /><pre class="prettyprint"><code>#include &lt;string&gt;<br />#include &lt;vector&gt;<br />#include "CRental.h"<br /><br />class Customer<br />{<br />    std::string _name;      //姓名<br />    std::vector<rental> _rentals;   //租借<br /><br />    public:<br />        Customer(std::string name);<br />        void addRental(Rental arg);<br />        std::string getName();<br />        //接續下一頁<br />        std::string statement();<br />};<br /><br />inline Customer::Customer(std::string name)<br />{<br />    _name = name;<br />}<br /><br />inline void Customer::addRental(Rental arg)<br />{<br />    _rentals.push_back(arg);<br />}<br /><br />inline std::string Customer::getName()<br />{<br />    return _name;<br />}<br /><br />inline std::string Customer::statement()<br />{<br />    double totalAmount = 0;       //消費總金額<br />    int frequentReterPoints = 0;  //常客積點<br />    std::vector<rental>::const_iterator rentals = _rentals.begin();<br />    std::string result = "Rental Record for " + getName() + "\n";<br /><br />    while(retals.hasMoreElements())<br />    {<br />        double thisAmount = 0;<br />        Rental each = (Rental)rentals.next();  //取得一筆租借記錄<br /><br />        //determine amounts for each line<br />        switch(each.getMovie().getPriceCode())  //取得影片出租價格<br />        {<br />        case Movie.REGULAR:<br />            thisAmount += 2;<br />            if (each.getDayRented() &gt; 2)<br />                thisAmount += (each.getDayRented()-2)*1.5;<br />            break;<br /><br />        case Movie.NEW_RELEASE:<br />            thisAmount += each.getDayRented()*3;<br />            break;<br /><br />        case Movie.CHILDRENS:<br />            thisAmount += 1.5;<br />            if (each.getDayRented() &gt; 3)<br />                thisAmount += (each.getDayRented()-3)*1.5;<br />            break;<br />        }<br /><br />        //add frequent renter points(累加 常客積點)<br />        frequentReterPoints++;<br /><br />        //add bonus for a two day new release rental<br />        if ((each.getMovie().getPriceCode() == Movie.NEW.RELEASE) &amp;&amp; each.getDayRented() &gt; 1))<br />            frequentReterPoints++;<br /><br />        //show figures for this rental (顯示這筆租借資料）<br />        result += "\t" + each.getMovie().getTitle() + "\t" + std::string.valueOf(thisAmount) + "\n";<br />        totalAmount += thisAmount;<br />    }<br /><br />    //add footer lines（結尾列印）<br />    result += "Amount owed is " + std::string.valueOf(totalAmount) + "\n";<br />    rental += "You earned " + std::string.valueOf(frequentReterPoints) + " frequent renter points";<br /><br />    return result;<br />}</rental></rental></code></pre><br /><br /><b>理性：</b><br />差的系統→很難找到修改點→很難修改<br />程式設計師很容易犯錯→引入bug<br /><br /><b>感性：</b><br />不好看，不美的程式<br /><br /><b>評價：</b><br />設計得不好，不符合物件導向的精神<br />Quick and dirty（快速而隨性）<br />Customer::statement()做的事，應該是由其它class完成的<br /><br /><b>接下來</b><br />使用者希望對系統做一些修改<br />希望以html的格式列印報表，直接在網頁上顯示，符合潮流<br /><br />困難點<br />根本不可能reuse目前statement()的任何行為<br />唯一能做的就是做一個htmlStatement()，copy-past statement()的內容再修改<br />若再修改，不就？？<br /><br /><b>接下來</b><br />使用者希望改變影片分類規則，但是還沒決定怎麼改<br />設想的方案中，都會影響顧客消費和常客積點的計算方式。<br /><br /><br />所以，我們需要開始重構（待續...）
